# Bug Fixes - November 12, 2025

## Issue #1: PNG Images Being Processed as Documents ✅ FIXED

### Problem
Extracted PNG images from PDFs were being re-queued for document processing, causing errors:
```
Failed to parse 1_tmppubm6t9_.pdf-4-1.png: 'utf-8' codec can't decode byte 0x89 in position 6: invalid start byte
```

### Root Cause
The Cloudflare Worker ([dataset-upload-notification-worker](cloudflare-workers/dataset-upload-notification-worker/src/index.ts)) handles R2 upload events and queues documents for processing. When Modal extracts images from PDFs and saves them to R2 at paths like:
```
{dataset_id}/{document_id}/images/*.png
```

These image uploads trigger R2 `PutObject` events, which the Worker was processing as new documents.

### Solution (Metadata-Based Approach)

**1. Backend: Tag assets with metadata** ([modal/services/storage.py](modal/services/storage.py#L91-L95))

When Modal uploads extracted images to R2, it now sets custom metadata:

```python
metadata = {
    'x-fltr-skip-processing': 'true' if skip_processing else 'false'
}

r2_client.put_object(
    Bucket=bucket_name,
    Key=object_key,
    Body=BytesIO(image_bytes),
    ContentType=content_type,
    Metadata=metadata,  # Explicitly mark as asset
)
```

**2. Cloudflare Worker: Check metadata first** ([dataset-upload-notification-worker/src/index.ts:73-90](cloudflare-workers/dataset-upload-notification-worker/src/index.ts#L73-L90))

```typescript
// Method 1: Check metadata flag (preferred - explicit intent)
const skipProcessing = notification.object.customMetadata?.['x-fltr-skip-processing'];
if (skipProcessing === 'true') {
    console.log('⏭️  Skipping asset (metadata flag set):', notification.object.key);
    message.ack();
    continue;
}

// Method 2: Path-based fallback (for backward compatibility)
if (notification.object.key.includes('/images/') ||
    notification.object.key.includes('/tables/') ||
    notification.object.key.includes('/charts/')) {
    console.log('⏭️  Skipping asset file (path-based fallback):', notification.object.key);
    message.ack();
    continue;
}
```

### Benefits

✅ **Explicit Intent**: Metadata clearly marks assets vs documents
✅ **Robust**: Doesn't rely on path conventions
✅ **Flexible**: Assets can be stored anywhere
✅ **Backward Compatible**: Path-based fallback for existing uploads
✅ **Future-Proof**: Works for any asset type (images, tables, charts, etc.)

### Status
**✅ Deployed** to Cloudflare Workers (Version: 23fe8ca9-0653-4a6e-b6d5-a03af5860ca2)
**✅ Deployed** to Modal

---

## Issue #2: Missing Modal Function Decorator ✅ FIXED

### Problem
```
AttributeError: 'function' object has no attribute 'spawn'
```

Webhook endpoint couldn't spawn document processing tasks.

### Root Cause
`process_document_modal` function was missing the `@app.function()` decorator at [modal/modal_app.py:446](modal/modal_app.py#L446), making it a regular Python function instead of a Modal function. Only Modal functions have the `.spawn()` method for async execution.

### Solution
Added `@app.function()` decorator with proper configuration:

```python
@app.function(
    image=image,
    cpu=8.0,
    memory=8192,
    timeout=3600,
    volumes={"/cache": volume},
    secrets=[...],
    min_containers=0,
    scaledown_window=600,
    max_containers=10,
)
async def process_document_modal(dataset_id: str, object_key: str, task_id: str = None) -> Dict[str, Any]:
    """Process a document end-to-end with checkpoint resumption"""
    # ... processing logic
```

### Status
**✅ Deployed** to Modal

---

## Issue #3: Milvus Schema Mismatch ✅ FIXED

### Problem
```
DataNotMatchException: Attempt to insert an unexpected field `filename` to collection without enabling dynamic field
```

### Root Cause
The vector store ([modal/services/vector_store.py](modal/services/vector_store.py)) was trying to insert fields that don't exist in the Milvus schema:

**Attempted to insert (but not in schema):**
- `filename` ❌
- `chunk_index` ❌
- `document_type` ❌

**Missing required fields:**
- `chunk_id` (primary key) ❌
- `title` ❌

### Solution
Updated [modal/services/vector_store.py](modal/services/vector_store.py#L36-L62) to match the schema defined in [modal/migrate_milvus_modal.py](modal/migrate_milvus_modal.py#L133-L173):

**Changes:**
1. Generate `chunk_id` (primary key): `f"{document_id}_{idx}"`
2. Add `title` field (from filename metadata)
3. Remove non-existent fields: `filename`, `chunk_index`, `document_type`
4. Keep only schema-defined fields:
   - Core: `chunk_id`, `text`, `vector`, `dataset_id`, `document_id`, `title`
   - OCR: `chunk_type`, `page`, `image_index`, `ocr_confidence`, `image_r2_key`, `image_size`

### Status
**✅ Deployed** to Modal

---

## Testing

Try uploading a PDF with images to verify:
1. ✅ PDF is processed successfully
2. ✅ Images are extracted and saved to R2
3. ✅ Images are NOT re-queued for document processing
4. ✅ Vectors are stored in Milvus without schema errors

## Related Files

**Cloudflare Worker:**
- [cloudflare-workers/dataset-upload-notification-worker/src/index.ts](cloudflare-workers/dataset-upload-notification-worker/src/index.ts)

**Modal Services:**
- [modal/services/vector_store.py](modal/services/vector_store.py)
- [modal/migrate_milvus_modal.py](modal/migrate_milvus_modal.py)

**FastAPI (already had filters):**
- [fastapi/services/queue_consumer.py](fastapi/services/queue_consumer.py)
- [fastapi/routers/webhooks.py](fastapi/routers/webhooks.py)
